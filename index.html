<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perwalian Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee; --primary-hover: #3751d4;
            --bg: #f0f4f8; --text-main: #1e293b;
            --text-muted: #64748b; --white: #ffffff;
        }

        * { box-sizing: border-box; transition: all 0.2s; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
        
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; font-weight: 600; cursor: pointer; color: var(--text-muted); border-radius: 8px; }
        .tab-btn.active { background: var(--primary); color: white; }

        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; }
        select, input, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; font-size: 0.9rem; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-print { background: #10b981; color: white; width: auto; padding: 10px 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85rem; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; vertical-align: top; }
        th { background: #f8fafc; color: var(--text-muted); font-weight: 700; }

        .hidden { display: none; }
        .only-print { display: none; }

        @media print {
            .no-print { display: none !important; }
            .only-print { display: block; text-align: center; margin-bottom: 20px; }
            body { background: white; padding: 0; }
            .card { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; }
            table { font-size: 10pt; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div id="loginSection">
            <h2 style="text-align:center; color:var(--primary)">Login Wali / BK</h2>
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="wali@smk.sch.id">
            <label>Password</label>
            <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button class="btn btn-primary" id="btnLogin" onclick="login()">Masuk ke Sistem</button>
        </div>

        <div id="mainApp" class="hidden">
            <div id="userInfo" style="margin-bottom: 15px; font-size: 0.8rem; color: var(--text-muted); font-weight: 600;"></div>
            
            <div class="nav-tabs no-print">
                <button class="tab-btn active" id="btnTabInput" onclick="switchTab('input')">Input Laporan</button>
                <button class="tab-btn" id="btnTabReport" onclick="switchTab('report')">Laporan & Cetak</button>
                <button class="tab-btn" onclick="location.reload()" style="color:#ef4444">Keluar</button>
            </div>

            <div id="tabInput">
                <label>Pilih Kelas</label>
                <select id="kelas" onchange="updateDaftarNama()"><option value="">-- Pilih Kelas --</option></select>
                <label>Nama Siswa</label>
                <select id="nama" onchange="isiNIS()"><option value="">-- Pilih Nama --</option></select>
                <label>NIS</label>
                <input id="nis" readonly style="background:#f1f5f9" placeholder="Otomatis...">
                <label>Status Kondisi</label>
                <select id="status">
                    <option value="Baik">üü¢ Baik / Normal</option>
                    <option value="Pembinaan">üü° Perlu Pembinaan</option>
                    <option value="Perhatian Khusus">üî¥ Perhatian Khusus</option>
                </select>
                <label>Catatan Observasi</label>
                <textarea id="catatan" rows="3" placeholder="Tulis detail laporan..."></textarea>
                <label>Tindak Lanjut</label>
                <textarea id="tindakLanjut" rows="2" placeholder="Apa rencana selanjutnya?"></textarea>
                <button class="btn btn-primary" id="btnSimpan" onclick="simpan()">üöÄ Simpan Laporan</button>
            </div>

            <div id="tabReport" class="hidden">
                <div class="no-print" style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="searchTable" onkeyup="filterData()" placeholder="Cari Nama atau Kelas...">
                    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Cetak / PDF</button>
                </div>
                
                <div class="only-print">
                    <h3>LAPORAN PERWALIAN SISWA</h3>
                    <p id="printDate"></p>
                </div>

                <div style="overflow-x: auto;">
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Kelas</th>
                                <th>Nama</th>
                                <th>Status</th>
                                <th>Catatan</th>
                                <th>Tindak Lanjut</th>
                            </tr>
                        </thead>
                        <tbody id="riwayatBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwWzwbKXgSa5agI-1qo3qB4-XIKBKL1wlWNoGPMer5r6ACWaxdWn79qzEw6uekorZKRlA/exec";
    let dataSiswa = [];
    let currentUser = "";

    async function login() {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        const btn = document.getElementById('btnLogin');
        if(!email || !pass) return alert("Email dan Password wajib diisi!");

        btn.disabled = true; btn.innerText = "Verifikasi...";
        try {
            const resp = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", email: email, password: pass })
            });
            const res = await resp.json();
            if(res.status === "success") {
                currentUser = res.email;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userInfo').innerText = "üìß Akun: " + currentUser;
                loadSiswa();
            } else { 
                alert("Gagal: " + res.msg); 
                btn.disabled = false; 
                btn.innerText = "Masuk ke Sistem"; 
            }
        } catch (e) { 
            alert("Kesalahan koneksi ke server!"); 
            btn.disabled = false; 
            btn.innerText = "Masuk ke Sistem";
        }
    }

    async function loadSiswa() {
        try {
            const resp = await fetch(API_URL + "?action=getSiswa");
            dataSiswa = await resp.json();
            const listKelas = [...new Set(dataSiswa.map(s => s.kelas))].sort();
            const selectKelas = document.getElementById('kelas');
            selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            listKelas.forEach(k => {
                let opt = document.createElement('option'); opt.value = k; opt.textContent = k;
                selectKelas.appendChild(opt);
            });
        } catch (e) { console.error("Gagal memuat siswa"); }
    }

    function updateDaftarNama() {
        const kls = document.getElementById('kelas').value;
        const selectNama = document.getElementById('nama');
        selectNama.innerHTML = '<option value="">-- Pilih Nama --</option>';
        dataSiswa.filter(s => s.kelas === kls).forEach(s => {
            let opt = document.createElement('option'); opt.value = s.nama; opt.textContent = s.nama;
            selectNama.appendChild(opt);
        });
        document.getElementById('nis').value = "";
    }

    function isiNIS() {
        const nm = document.getElementById('nama').value;
        const s = dataSiswa.find(x => x.nama === nm);
        document.getElementById('nis').value = s ? s.nis : "";
    }

    function switchTab(tab) {
        document.getElementById('tabInput').classList.toggle('hidden', tab !== 'input');
        document.getElementById('tabReport').classList.toggle('hidden', tab !== 'report');
        document.getElementById('btnTabInput').classList.toggle('active', tab === 'input');
        document.getElementById('btnTabReport').classList.toggle('active', tab === 'report');
        if(tab === 'report') loadRiwayat();
    }

    async function loadRiwayat() {
        const body = document.getElementById('riwayatBody');
        body.innerHTML = '<tr><td colspan="6" style="text-align:center">Sedang memuat riwayat...</td></tr>';
        try {
            const resp = await fetch(API_URL + "?action=getRiwayat");
            const data = await resp.json();
            body.innerHTML = "";
            if(data.length === 0) {
                body.innerHTML = '<tr><td colspan="6" style="text-align:center">Belum ada data laporan.</td></tr>';
                return;
            }
            data.forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${r.tanggal || '-'}</td>
                    <td>${r.kelas || '-'}</td>
                    <td><strong>${r.nama || 'Tanpa Nama'}</strong></td>
                    <td>${r.status || '-'}</td>
                    <td>${r.catatan || '-'}</td>
                    <td>${r.tindak_lanjut || '-'}</td>
                `;
                body.appendChild(row);
            });
            document.getElementById('printDate').innerText = "Dicetak pada: " + new Date().toLocaleString('id-ID');
        } catch (e) { 
            body.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Gagal memuat data riwayat.</td></tr>'; 
        }
    }

    function filterData() {
        const input = document.getElementById("searchTable").value.toUpperCase();
        const tr = document.getElementById("riwayatBody").getElementsByTagName("tr");
        for (let i = 0; i < tr.length; i++) {
            const rowContent = tr[i].textContent || tr[i].innerText;
            tr[i].style.display = rowContent.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

    async function simpan() {
        const btn = document.getElementById('btnSimpan');
        const payload = {
            action: "simpan",
            nis: document.getElementById('nis').value,
            nama: document.getElementById('nama').value,
            status: document.getElementById('status').value,
            catatan: document.getElementById('catatan').value,
            tindak_lanjut: document.getElementById('tindakLanjut').value,
            wali: currentUser,
            kelas: document.getElementById('kelas').value
        };

        if(!payload.nama || !payload.catatan) return alert("Nama Siswa dan Catatan wajib diisi!");

        btn.disabled = true; btn.innerText = "‚è≥ Sedang Mengirim...";
        
        try {
            // Menghapus mode: "no-cors" agar Apps Script bisa memproses JSON dengan benar
            const response = await fetch(API_URL, { 
                method: "POST", 
                body: JSON.stringify(payload) 
            });
            
            // Karena Apps Script Redirect, kita mungkin tidak mendapat JSON balik di beberapa browser
            // Namun data biasanya tetap masuk.
            alert("‚úÖ Laporan Berhasil Disimpan!");
            document.getElementById('catatan').value = "";
            document.getElementById('tindakLanjut').value = "";
        } catch (e) { 
            console.error(e);
            alert("Sistem sedang memproses. Silakan cek tab Laporan dalam beberapa saat."); 
        } finally {
            btn.disabled = false; btn.innerText = "üöÄ Simpan Laporan";
        }
    }
</script>
</body>
</html>
