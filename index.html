<!DOCTYPE html>
<html lang="id">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Sistem Perwalian Digital</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  :root { --primary: #4361ee; --bg: #f0f4f8; --white: #ffffff; }
Â  Â  Â  Â  body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
Â  Â  Â  Â  .container { max-width: 1100px; margin: auto; } /* Lebar container ditambah sedikit */
Â  Â  Â  Â  .card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .hidden { display: none; }
Â  Â  Â  Â  .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
Â  Â  Â  Â  .tab-btn { padding: 10px 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; }
Â  Â  Â  Â  .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
Â  Â  Â  Â  label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.8rem; }
Â  Â  Â  Â  select, input, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; box-sizing: border-box; }
Â  Â  Â  Â  .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 15px; }
Â  Â  Â  Â  .btn-primary { background: var(--primary); color: white; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Table Styles Updated */
Â  Â  Â  Â  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
Â  Â  Â  Â  th, td { border: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
Â  Â  Â  Â  th { background: #f8fafc; font-weight: 700; color: #333; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .badge-bk { background: #fee2e2; color: #dc2626; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Status Colors */
Â  Â  Â  Â  .status-baik { color: green; font-weight: bold; }
Â  Â  Â  Â  .status-pembinaan { color: orange; font-weight: bold; }
Â  Â  Â  Â  .status-khusus { color: red; font-weight: bold; }

Â  Â  Â  Â  @media print { .no-print { display: none; } }
Â  Â  </style>
</head>
<body>

<div class="container">
Â  Â  <div class="card">
Â  Â  Â  Â  <div id="loginSection">
Â  Â  Â  Â  Â  Â  <h2 style="text-align:center">Login Sistem Perwalian</h2>
Â  Â  Â  Â  Â  Â  <input type="email" id="loginEmail" placeholder="Email">
Â  Â  Â  Â  Â  Â  <input type="password" id="loginPass" placeholder="Password">
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="login()">Masuk</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="mainApp" class="hidden">
Â  Â  Â  Â  Â  Â  <div id="userInfo" style="font-size: 0.8rem; color: #666; margin-bottom: 10px;"></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="nav-tabs no-print">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab-btn active" id="tabIn" onclick="switchTab('input')">Input Laporan</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab-btn" id="tabRep" onclick="switchTab('report')">Laporan & Riwayat</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab-btn" onclick="location.reload()" style="color:red">Logout</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="tabInput">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Kelas</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="kelas" onchange="updateDaftarNama()"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nama Siswa</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="nama" onchange="isiNIS()"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <label>NIS</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="nis" readonly style="background:#f9f9f9">

Â  Â  Â  Â  Â  Â  Â  Â  <label>Status</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Baik">ğŸŸ¢ Baik</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pembinaan">ğŸŸ¡ Pembinaan</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Perhatian Khusus">ğŸ”´ Perhatian Khusus</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  Â  Â  <label>Catatan Wali Kelas (Permasalahan/Prestasi)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="catatan" rows="3" placeholder="Tuliskan catatan kejadian..."></textarea>

Â  Â  Â  Â  Â  Â  Â  Â  <label>Tindak Lanjut / Solusi</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="tindakLanjut" rows="2" placeholder="Langkah yang sudah/akan diambil..."></textarea>

Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" id="btnSimpan" onclick="simpan()">Simpan Data</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="tabReport" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="no-print">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="cari" onkeyup="filterTabel()" placeholder="Cari nama atau kelas...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="margin-top:10px; padding:8px 15px; cursor:pointer; background:#333; color:white; border:none; border-radius:5px;">ğŸ–¨ï¸ Cetak / PDF</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <table id="tabelRiwayat">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%">Tanggal</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%">Kelas & Nama</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%">Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 30%">Catatan Wali Kelas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 25%">Tindak Lanjut</th> <th style="width: 15%">Pelapor</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="riwayatBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  const API_URL = "https://script.google.com/macros/s/AKfycbyTjmavDuJRe97fWhI5mWzmNNpN1k1qJ4C4MjK4l4uat8bP67mjhRSbR-bMOTJk9Wv2/exec";
Â  Â  let dataSiswa = [];
Â  Â  let user = {};

Â  Â  async function login() {
Â  Â  Â  Â  const email = document.getElementById('loginEmail').value;
Â  Â  Â  Â  const pass = document.getElementById('loginPass').value;
Â  Â  Â  Â  if(!email || !pass) return alert("Harap isi email dan password");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const btn = document.querySelector('#loginSection button');
Â  Â  Â  Â  btn.innerText = "Loading..."; btn.disabled = true;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const resp = await fetch(API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: "login", email: email, password: pass })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const res = await resp.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(res.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  user = res;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginSection').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mainApp').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userInfo').innerHTML = `ğŸ‘¤ <b>${user.role}</b> | ${user.email} ${user.role === 'Wali' ? '| Kelas: '+user.adminKelas : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  loadSiswa();
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  alert(res.msg);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e) { alert("Gagal koneksi server"); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  btn.innerText = "Masuk"; btn.disabled = false;
Â  Â  }

Â  Â  async function loadSiswa() {
Â  Â  Â  Â  const resp = await fetch(API_URL + "?action=getSiswa");
Â  Â  Â  Â  dataSiswa = await resp.json();
Â  Â  Â  Â  const selectKelas = document.getElementById('kelas');
Â  Â  Â  Â Â 
Â  Â  Â  Â  let listKelas = [...new Set(dataSiswa.map(s => s.kelas))];
Â  Â  Â  Â  if(user.role === "Wali") {
Â  Â  Â  Â  Â  Â  listKelas = listKelas.filter(k => k === user.adminKelas);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  selectKelas.innerHTML = '<option value="">-- Pilih --</option>';
Â  Â  Â  Â  listKelas.sort().forEach(k => {
Â  Â  Â  Â  Â  Â  selectKelas.innerHTML += `<option value="${k}">${k}</option>`;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function updateDaftarNama() {
Â  Â  Â  Â  const kls = document.getElementById('kelas').value;
Â  Â  Â  Â  const selectNama = document.getElementById('nama');
Â  Â  Â  Â  selectNama.innerHTML = '<option value="">-- Pilih --</option>';
Â  Â  Â  Â  dataSiswa.filter(s => s.kelas === kls).forEach(s => {
Â  Â  Â  Â  Â  Â  selectNama.innerHTML += `<option value="${s.nama}">${s.nama}</option>`;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function isiNIS() {
Â  Â  Â  Â  const nm = document.getElementById('nama').value;
Â  Â  Â  Â  const s = dataSiswa.find(x => x.nama === nm);
Â  Â  Â  Â  document.getElementById('nis').value = s ? s.nis : "";
Â  Â  }

Â  Â  function switchTab(t) {
Â  Â  Â  Â  document.getElementById('tabInput').classList.toggle('hidden', t !== 'input');
Â  Â  Â  Â  document.getElementById('tabReport').classList.toggle('hidden', t !== 'report');
Â  Â  Â  Â  document.getElementById('tabIn').classList.toggle('active', t === 'input');
Â  Â  Â  Â  document.getElementById('tabRep').classList.toggle('active', t === 'report');
Â  Â  Â  Â  if(t === 'report') loadRiwayat();
Â  Â  }

Â  Â  async function loadRiwayat() {
Â  Â  Â  Â  const body = document.getElementById('riwayatBody');
Â  Â  Â  Â  body.innerHTML = '<tr><td colspan="6" style="text-align:center">Mengambil data...</td></tr>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const resp = await fetch(API_URL + "?action=getRiwayat");
Â  Â  Â  Â  Â  Â  let data = await resp.json();

Â  Â  Â  Â  Â  Â  // Filter Wali
Â  Â  Â  Â  Â  Â  if(user.role === "Wali") {
Â  Â  Â  Â  Â  Â  Â  Â  data = data.filter(r => r.kelas === user.adminKelas);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Sort berdasarkan tanggal terbaru
Â  Â  Â  Â  Â  Â  data.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

Â  Â  Â  Â  Â  Â  body.innerHTML = "";
Â  Â  Â  Â  Â  Â  if(data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  body.innerHTML = '<tr><td colspan="6" style="text-align:center">Belum ada catatan.</td></tr>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  data.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  let statusColor = "";
Â  Â  Â  Â  Â  Â  Â  Â  if(r.status === "Baik") statusColor = "status-baik";
Â  Â  Â  Â  Â  Â  Â  Â  else if(r.status === "Pembinaan") statusColor = "status-pembinaan";
Â  Â  Â  Â  Â  Â  Â  Â  else statusColor = "status-khusus";

Â  Â  Â  Â  Â  Â  Â  Â  // PERBAIKAN: Menampilkan Catatan DAN Tindak Lanjut
Â  Â  Â  Â  Â  Â  Â  Â  body.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><small>${r.tanggal.split('T')[0]}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${r.nama}</b><br><small>${r.kelas}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="${statusColor}">${r.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.catatan}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="background:#fdfdfd; font-style:italic;">${r.tindak_lanjut ? r.tindak_lanjut : '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><small>${r.wali.split('@')[0]}</small> ${user.role === 'BK' ? '<span class="badge-bk">BK</span>' : ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  body.innerHTML = '<tr><td colspan="6" style="color:red; text-align:center">Gagal memuat data.</td></tr>';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function simpan() {
Â  Â  Â  Â  const btn = document.getElementById('btnSimpan');
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  action: "simpan",
Â  Â  Â  Â  Â  Â  nis: document.getElementById('nis').value,
Â  Â  Â  Â  Â  Â  nama: document.getElementById('nama').value,
Â  Â  Â  Â  Â  Â  status: document.getElementById('status').value,
Â  Â  Â  Â  Â  Â  catatan: document.getElementById('catatan').value,
Â  Â  Â  Â  Â  Â  tindak_lanjut: document.getElementById('tindakLanjut').value,
Â  Â  Â  Â  Â  Â  wali: user.email,
Â  Â  Â  Â  Â  Â  kelas: document.getElementById('kelas').value
Â  Â  Â  Â  };
Â  Â  Â  Â  if(!payload.nama || !payload.catatan) return alert("Wajib isi Nama Siswa & Catatan!");
Â  Â  Â  Â Â 
Â  Â  Â  Â  btn.disabled = true; btn.innerText = "Menyimpan ke Server...";
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
Â  Â  Â  Â  Â  Â  alert("Data berhasil disimpan!");
Â  Â  Â  Â  Â  Â  document.getElementById('catatan').value = "";
Â  Â  Â  Â  Â  Â  document.getElementById('tindakLanjut').value = "";
Â  Â  Â  Â  Â  Â  switchTab('report'); // Otomatis pindah ke laporan setelah simpan
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  alert("Gagal menyimpan data.");
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  btn.disabled = false; btn.innerText = "Simpan Data";
Â  Â  }

Â  Â  function filterTabel() {
Â  Â  Â  Â  const val = document.getElementById('cari').value.toLowerCase();
Â  Â  Â  Â  const rows = document.querySelectorAll('#riwayatBody tr');
Â  Â  Â  Â  rows.forEach(r => {
Â  Â  Â  Â  Â  Â  r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none";
Â  Â  Â  Â  });
Â  Â  }
</script>
</body>
</html>


const SS_ID = "12cmg9LkEVVkj2dSzd8b1wZMza3zHfD71ZuUjoUeahdo";

function doGet(e) {
Â  const action = e.parameter.action;
Â  const ss = SpreadsheetApp.openById(SS_ID);
Â  
Â  if (action === "getSiswa") {
Â  Â  const sheet = ss.getSheetByName("siswa");
Â  Â  const data = sheet.getDataRange().getValues();
Â  Â  const result = data.slice(1).map(r => ({ nis: r[0], nama: r[2], kelas: r[3] }));
Â  Â  return renderJson(result);
Â  }

Â  if (action === "getRiwayat") {
Â  Â  const sheet = ss.getSheetByName("perwalian");
Â  Â  const data = sheet.getDataRange().getValues();
Â  Â  if (data.length <= 1) return renderJson([]);

Â  Â  const result = data.slice(1).map(r => ({
Â  Â  Â  tanggal: r[0] ? Utilities.formatDate(new Date(r[0]), "GMT+7", "dd/MM/yyyy") : "-",
Â  Â  Â  nis: r[1],
Â  Â  Â  nama: r[2],
Â  Â  Â  status: r[3],
Â  Â  Â  catatan: r[4],
Â  Â  Â  tindak_lanjut: r[5],
Â  Â  Â  wali: r[6],
Â  Â  Â  kelas: r[7]
Â  Â  }));
Â  Â  return renderJson(result.reverse());
Â  }
Â  return renderJson({error: "Action not found"});
}

function doPost(e) {
Â  try {
Â  Â  const ss = SpreadsheetApp.openById(SS_ID);
Â  Â  const data = JSON.parse(e.postData.contents);

Â  Â  if (data.action === "login") {
Â  Â  Â  const sheet = ss.getSheetByName("users");
Â  Â  Â  const users = sheet.getDataRange().getValues();
Â  Â  Â  const user = users.find(r => r[0] === data.email && r[1].toString() === data.password.toString());
Â  Â  Â  
Â  Â  Â  if (user) {
Â  Â  Â  Â  return renderJson({ 
Â  Â  Â  Â  Â  status: "success", 
Â  Â  Â  Â  Â  email: user[0], 
Â  Â  Â  Â  Â  role: user[2], // Wali atau BK
Â  Â  Â  Â  Â  adminKelas: user[3] || "" // Kelas yang diampu jika wali
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  return renderJson({ status: "error", msg: "Login Gagal!" });
Â  Â  Â  }
Â  Â  }

Â  Â  if (data.action === "simpan") {
Â  Â  Â  const sheet = ss.getSheetByName("perwalian");
Â  Â  Â  sheet.appendRow([
Â  Â  Â  Â  new Date(), data.nis, data.nama, data.status, 
Â  Â  Â  Â  data.catatan, data.tindak_lanjut, data.wali, data.kelas
Â  Â  Â  ]);
Â  Â  Â  return renderJson({ status: "success" });
Â  Â  }
Â  } catch (err) {
Â  Â  return renderJson({ status: "error", msg: err.toString() });
Â  }
}

function renderJson(obj) {
Â  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}


Singkronkan
