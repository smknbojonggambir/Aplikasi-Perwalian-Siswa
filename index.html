<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perwalian Modern v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --p: #4361ee; --bg: #f8f9fc; --txt: #2b2d42; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding: 20px; }
        .card { max-width: 500px; margin: 20px auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 30px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #64748b; }
        select, input, textarea { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #edf2f7; border-radius: 12px; font-size: 15px; outline: none; box-sizing: border-box; }
        select:focus, textarea:focus { border-color: var(--p); }
        button { width: 100%; padding: 15px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; }
        button:disabled { background: #cbd5e1; }
        .loading { text-align: center; font-size: 12px; color: var(--p); display: none; }
    </style>
</head>
<body>

<header>
    <h2 style="margin:0; color:var(--p)">Form Perwalian</h2>
    <p style="color:#64748b; font-size:14px">Pilih kelas untuk memunculkan nama siswa</p>
</header>

<div class="card">
    <div id="loadData" style="text-align:center; padding:10px;">Memuat data siswa...</div>
    
    <div id="mainForm" style="display:none">
        <label>Pilih Kelas</label>
        <select id="f_kelas" onchange="filterNama()">
            <option value="">-- Pilih Kelas --</option>
        </select>

        <label>Pilih Nama Siswa</label>
        <select id="f_nama" onchange="getNIS()">
            <option value="">-- Pilih Nama --</option>
        </select>

        <label>NIS</label>
        <input id="f_nis" readonly placeholder="Terisi otomatis">

        <label>Status Kondisi</label>
        <select id="f_status">
            <option value="Baik">ðŸŸ¢ Baik / Normal</option>
            <option value="Pembinaan">ðŸŸ¡ Perlu Pembinaan</option>
            <option value="Perhatian Khusus">ðŸ”´ Perhatian Khusus</option>
        </select>

        <label>Detail Laporan</label>
        <textarea id="f_catatan" rows="4" placeholder="Tuliskan laporan perwalian..."></textarea>

        <button id="btnSimpan" onclick="kirimData()">Simpan Data</button>
        <div id="statusMsg" class="loading">Mengirim laporan...</div>
    </div>
</div>

<script>
    const API_URL = "URL_WEB_APP_ANDA"; // Masukkan URL Deployment Google Script
    let masterSiswa = [];

    // 1. AMBIL DATA DARI GOOGLE SHEET SAAT LOAD
    window.onload = async () => {
        try {
            const resp = await fetch(API_URL);
            masterSiswa = await resp.json();
            
            // Isi Dropdown Kelas unik
            const daftarKelas = [...new Set(masterSiswa.map(s => s.kelas))];
            const selKelas = document.getElementById('f_kelas');
            daftarKelas.forEach(kls => {
                selKelas.innerHTML += `<option value="${kls}">${kls}</option>`;
            });

            document.getElementById('loadData').style.display = 'none';
            document.getElementById('mainForm').style.display = 'block';
        } catch (e) {
            document.getElementById('loadData').innerText = "Gagal memuat data. Periksa API URL.";
        }
    };

    // 2. FILTER NAMA BERDASARKAN KELAS
    function filterNama() {
        const kelas = document.getElementById('f_kelas').value;
        const selNama = document.getElementById('f_nama');
        selNama.innerHTML = '<option value="">-- Pilih Nama --</option>';
        
        const filtered = masterSiswa.filter(s => s.kelas === kelas);
        filtered.forEach(s => {
            selNama.innerHTML += `<option value="${s.nama}">${s.nama}</option>`;
        });
        document.getElementById('f_nis').value = "";
    }

    // 3. AUTO NIS
    function getNIS() {
        const nama = document.getElementById('f_nama').value;
        const siswa = masterSiswa.find(s => s.nama === nama);
        document.getElementById('f_nis').value = siswa ? siswa.nis : "";
    }

    // 4. KIRIM DATA KE SHEET
    async function kirimData() {
        const btn = document.getElementById('btnSimpan');
        const loader = document.getElementById('statusMsg');
        
        const data = {
            nis: document.getElementById('f_nis').value,
            nama: document.getElementById('f_nama').value,
            kelas: document.getElementById('f_kelas').value,
            status: document.getElementById('f_status').value,
            catatan: document.getElementById('f_catatan').value
        };

        if(!data.nama || !data.catatan) return alert("Lengkapi data!");

        btn.disabled = true;
        loader.style.display = 'block';

        try {
            await fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(data)
            });
            alert("âœ… Laporan Berhasil Disimpan!");
            document.getElementById('f_catatan').value = "";
        } catch (e) {
            alert("Terjadi kesalahan.");
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>
